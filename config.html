<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>IRU</title>

<link rel="stylesheet" media="all" href="/site_media/resources/bootstrap/css/bootstrap.min.css"/>
<link href="/site_media/resources/kendo/styles/kendo.common.min.css" rel="stylesheet"/>
<link href="/site_media/resources/less/kendo.tb.min.css" rel="stylesheet"/>
<link type="text/css" rel="stylesheet" href="/site_media/resources/styles/tb-layout.css"/>
<link type="text/css" rel="stylesheet" href="/site_media/resources/styles/tb-styles.min.css"/>

<script src="/site_media/resources/jquery/jquery-1.8.2.min.js"></script>
<script src="/site_media/resources/scripts/tb.jquery.min.js"></script>
<script src="/site_media/js/json2.min.js"></script>
<script src="/site_media/resources/bootstrap/js/bootstrap.min.js"></script>

<!--make local copies of these -->

<script src="/pluginMedia/IonReporterUploader/underscore-min.js"></script>
<script src="/pluginMedia/IonReporterUploader/backbone-min.js"></script>
<script src="/pluginMedia/IonReporterUploader/backbone.syphon.min.js"></script>
<script src="/pluginMedia/IonReporterUploader/handlebars.min.js"></script>
<script src="/pluginMedia/IonReporterUploader/backbone-validation-min.js"></script>

<!-- TODO remove aprise -->
<script type="text/javascript" src="/site_media/jquery/js/apprise/apprise-1.5.min.js"></script>
<link rel="stylesheet" href="/site_media/jquery/js/apprise/apprise.css" type="text/css"/>

<style>

    body {
        /*the first height has to be the max height size for the iFrame plugin */
        height: 755px;
        background: #FFFFFF;
        background: -moz-linear-gradient(center bottom , #FFFFFF 100%) repeat scroll center 100px #EFEFEF;
    }

    .container {
        float: none;
        margin-left: auto;
        margin-right: auto;
    }

    .topSpace {
        margin-top: 20px;
    }

    .confirmTest {
        margin-left: 15px;
        margin-right: 10px;
        font-weight: bold;
    }

    /*get rid of the table bottom margin*/
    .table {
        margin-bottom: 0px;
    }

    .k-grid td {
        font-size: 1em;
    }

    .modal-button-row {
        border-style: solid;
        background-image: none, linear-gradient(to bottom, #F6F6F6 0px, #EAEAEA 100%);
        border-width: 1px;
        border-color: #C5C5C5;
        padding: 5px;
        border-radius: 3px;
        margin-top: 20px;
    }

    .divider {
        border-left: 1px solid #F2F2F2;
        border-right: 1px solid #FFFFFF;
        float: left;
        height: 30px;
        margin: 0 9px;
    }

    .hr {
        margin-bottom: 10px;
        height: 4px;    
        float: none;
        margin-left: 0;
        width: 910px;
        background-image: linear-gradient(bottom, #C2C2C2 4%, #EDEDED 52%);
        background-image: -o-linear-gradient(bottom, #C2C2C2 4%, #EDEDED 52%);
        background-image: -moz-linear-gradient(bottom, #C2C2C2 4%, #EDEDED 52%);
        background-image: -webkit-linear-gradient(bottom, #C2C2C2 4%, #EDEDED 52%);
        background-image: -ms-linear-gradient(bottom, #C2C2C2 4%, #EDEDED 52%);
        background-image: -webkit-gradient(linear, left bottom, left top, color-stop(0.04, #C2C2C2), color-stop(0.52, #EDEDED));
    }

    input[type="text"] {
        width: 300px;
    }

    input[type="password"] {
        width: 300px;
    }

    .form-horizontal .control-label {
        float: left;
        padding-top: 5px;
        text-align: right;
        width: 120px;
    }

    .form-horizontal .controls {
        margin-left: 135px;
    }

    #token {
        width: 785px;
    }

    .nameCol {
        width: 750px;
    }

    .nameSelectCol {
        width: 600px;
    }

    .smallCol {
        width: 50px;
    }

    .medCol {
        width: 100px;
    }

    .editCol {
        text-align: center;
        text-indent: 10px;
    }

    .centerCol {
        text-indent: 10px;
    }

    .versionStatus {
        position: relative;
        top: 7px;
    }

    .versionError {
        color: #b94a48;
        position: relative;
        top: 7px;
    }

    .legacyRow{
        color: #b94a48;
    }

    .legacyWarning{
        color: #b94a48;
        font-weight: bold;
    }

    .oldIR{
        color: #b94a48;
        font-weight: bold;
    }

    .newIR{
        visibility: hidden;
    }


</style>

<script type="text/template" id="config">

    <div id="list">

        <h3>Ion Reporter Uploader Account Configuration</h3>

        <div class="row">
            <div class="span12">
                <div class="btn-group pull-right">
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="icon-plus"></i> Add Account
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu">
                        <li><a id="ir40cloud" tabindex="-1" href="#">Ion Reporter Cloud</a></li>
                        <li><a id="ir4" tabindex="-1" href="#">Ion Reporter</a></li>
                        <!-- <li><a id="ir4Genexus" tabindex="-1" href="#">Genexus</a></li>-->
                       <!-- <li><a id="ir7" tabindex="-1" href="#">Ion Reporter 7.0 +</a></li>-->
                        <li style="float: none;" class="divider"></li>
                        <li><a id="ir4" tabindex="-1" href="http://www.thermofisher.com/in/en/home/life-science/sequencing/next-generation-sequencing/ion-torrent-next-generation-sequencing-workflow/ion-torrent-next-generation-sequencing-data-analysis-workflow/ion-reporter-software.html" target="_blank">Signup for Ion Reporter</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row topSpace">
            <div class="span12 k-widget k-grid" id="table-wrap" style="height: 350px; overflow-y: scroll;">
                <table class="table table-striped">
                    <thead class="k-grid-header">
                    <tr>
                        <th class="k-header nameCol">Name</th>
                        <th class="k-header smallCol">Default</th>
                        <th class="k-header smallCol">Status</th>
                        <th class="k-header smallCol centerCol">Edit</th>
                    </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="modal"></div>
    <div id="whine" style="display: none;">At least one Ion Reporter account is needed. Please add one now.</div>

</script>

<script type="text/template" id="instance">

    <div id="list">

        <h3>Select Ion Reporter account</h3>

        <div class="row topSpace">
            <div class="span12 k-widget k-grid" id="table-wrap">
                <table class="table table-striped">
                    <thead class="k-grid-header">
                    <tr>
                        <th class="k-header nameSelectCol">Name</th>
                        <th class="k-header smallCol">Default</th>
                        <th class="k-header smallCol">Status</th>
                        <th class="k-header medCol">Launch</th>
                    </tr>
                    </thead>
                    <tbody id="table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label">Upload Options</label>

                <!--TODO add help text-->
                <div class="controls">
                    <label class="radio">
                        <input type="radio" name="upload" value="bam_only">
                        .bam only
                    </label>
                    <label class="radio">
                        <input type="radio" name="upload" value="vcf_only">
                        .vcf only
                    </label>
                    <label class="radio">
                        <input type="radio" name="upload" value="both" checked>
                        .vcf and .bam
                    </label>
                </div>

            </div>

        </form>

        <div id="whine" style="display: none;">At least one Ion Reporter account is needed. <a href="/configure/ionreporter" target="_top">Please add one now.</a></div>

    </div>

</script>

<script type="text/template" id="version">

    <label class="radio">
        <input type="radio" name="version" value="{{version}}" {{checked}} {{#unless isNew}}disabled{{/unless}}>
        {{fullHumanVersion version}}
    </label>

</script>

<script type="text/template" id="versionStatus">
    <span class="{{ status }}">{{{ msg }}}</span>
</script>

<script type="text/template" id="row-layout">
    <td class="nameCol"><strong>{{name}}</strong>
        {{# if details }}
            <span style="margin-left: 10px"></span>(Version: {{humanVersion version}} | User: {{details.firstname}} {{details.lastname}} | Org: {{details.orgname}})
        {{/if}}

         <span class="{{isLegacy version}}">  Ion Reporter 1.X is now obsolete. </span>
    </td>
    <td class="smallCol centerCol">{{# if default}}<i class="icon-ok"></i>{{/if}}</td>
    <td class="smallCol centerCol"><img id="{{id}}" class="status-icon"  data-toggle="tooltip" title="Checking account status" src="/site_media/jquery/img/throbber.gif" /></td>
    <td class="smallCol"><span class="btn config"><i class="icon-edit"></i></span></td>
</script>

<script type="text/template" id="select-row-layout">
    <td class="nameCol"><strong>{{name}}</strong>

        {{# if details }}
            <span style="margin-left: 10px"></span>(Version: {{humanVersion version}} | User: {{details.firstname}} {{details.lastname}} | Org: {{details.orgname}})
        {{/if}}

        <span class="{{isLegacy version}}">  Ion Reporter 1.X is now obsolete. </span>

    <td class="smallCol centerCol">{{# if default}}<i class="icon-ok"></i>{{/if}}</td>
    <td class="smallCol centerCol"><img id="{{id}}" class="status-icon"  data-toggle="tooltip" title="Checking account status" src="/site_media/jquery/img/throbber.gif" /></td>

    <td class="medCol">{{isLegacyInstance version}}</td>

</script>

<script type="text/template" id="modal_layout">
    <div id="ir-config" class="row">
        <h3>{{#if isNew}}Add{{else}}Edit{{/if}} Ion Reporter account</h3>

        <div class="topSpace span12">
            <div id="timeout" class="alert alert-error" style="display: none;"></div>

            <form class="form-horizontal ir" autocomplete="off">

                <div class="control-group">
                    <label class="control-label">Server Type</label>

                    <div class="controls">
                        <label class="radio">
                            <input type="radio" name="protocol" value="https" {{https}} {{#unless isNew}}disabled{{/unless}}>
                            HTTPS
                        </label>

                        <label class="radio">
                            <input type="radio" name="protocol" value="http" {{http}} {{#unless isNew}}disabled{{/unless}}>
                            HTTP
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="name">Display Name</label>

                    <div class="controls">
                        <input type="text" id="name" name="name" placeholder="" maxlength="255" value="{{name}}"
                               autocomplete="off">
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="server">Server</label>

                    <div class="controls">
                        <input type="text" id="server" name="server" placeholder="" value="{{server}}" maxlength="255" 
                               autocomplete="off" {{#unless isNew}}disabled{{/unless}}>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="port">Port</label>

                    <div class="controls">
                        <input type="text" id="port" name="port" maxlength="5" onkeypress='return event.charCode === 0 || (event.charCode >= 48 && event.charCode <= 57)' value="{{port}}" autocomplete="off" {{#unless isNew}}disabled{{/unless}}>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="userid">Username</label>

                    <div class="controls">
                        <input type="text" id="userid" name="userid" placeholder="" value="{{userid}}" {{#unless isNew}}disabled{{/unless}}>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="password">Password</label>


                    <div class="controls">
                        <input type="password" id="password" name="password"
                        {{#if confirm}}placeholder="edit to change password"{{/if}}>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">Default</label>

                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox" name="default" {{#if default}}checked{{/if}} >
                            Set as default account. The default account is the preferred Ion Reporter Account for
                            auto-analysis.
                        </label>
                    </div>
                </div>

                <div class="control-group version-control">
                    <label class="control-label">Version</label>

                    <div class="controls version-group">
                    </div>

                </div>

                {{#if confirm}}
                <div class="control-group">
                    <div class="controls">
                        <span class='btn versionCheck {{#unless isNew}}hide{{/unless}}'><i class='icon-repeat'></i> Get versions</span>
                    </div>
                </div>
                {{/if}}

            </form>
        </div>

        <div class="row">
            <div class="span12 modal-button-row">
                <span class="btn pull-left ir-back"><i class="icon-arrow-left"></i> Back</span>
                {{#if confirm}}
                <span class="divider"></span>
                <span class="btn ir-delete"><i class="icon-trash"></i> Delete</span>
                    <span class="confirm" style="display: none;">
                        <span class="confirmTest">Are you sure you want to delete this configuration?</span>
                        <span class="btn-group confirm">
                            <button class="btn confirmFalse">No</button>
                            <button class="btn confirmTrue btn-danger">Yes</button>
                        </span>
                    </span>
                {{/if}}
                <span class="btn pull-right {{storeClass}}"><i class="icon-{{icon}}"></i> {{storeText}}</span>
            </div>
        </div>

    </div>
</script>

<script>

Handlebars.registerHelper('humanVersion', function (version) {
    if (version) {
        var major = version[2];
        var minor = version.substring(3);
        return major + "." + minor
    } else {
        return ""
    }

});
Handlebars.registerHelper('fullHumanVersion', function (version) {
    if (version) {
        var major = version[2];
        var minor = version.substring(3);
        return "Ion Reporter " + major + "." + minor
    } else {
        return ""
    }

});

Handlebars.registerHelper('isLegacy', function (version) {
    var major = version[2];
    var minor = version.substring(3);
    if (major == 1){
        return "oldIR";
    }else{
        return "newIR";
    }
});

Handlebars.registerHelper('isLegacyInstance', function (version) {
    var major = version[2];
    var minor = version.substring(3);
    if (major == 1){
        var result = '<span class="btn btn-danger disabled">Disabled IRU</span>';
    }else{
        var result = '<span class="btn launch btn-primary">Launch IRU</span>';
    }
    return new Handlebars.SafeString(result);
});

//backbone validation bootstrap wrapper
_.extend(Backbone.Validation.callbacks, {
    valid: function (view, attr, selector) {
        var control, group;
        control = view.$('[' + selector + '=' + attr + ']');
        group = control.parents(".control-group");
        group.removeClass("error");
        if (control.data("error-style") === "tooltip") {
            if (control.data("tooltip")) {
                return control.tooltip("hide");
            }
        } else if (control.data("error-style") === "inline") {
            return group.find(".help-inline.error-message").remove();
        } else {
            return group.find(".help-block.error-message").remove();
        }
    },
    invalid: function (view, attr, error, selector) {
        var control, group, position, target;
        control = view.$('[' + selector + '=' + attr + ']');
        group = control.parents(".control-group");
        group.addClass("error");
        if (control.data("error-style") === "tooltip") {
            position = control.data("tooltip-position") || "right";
            control.tooltip({
                placement: position,
                trigger: "manual",
                title: error
            });
            return control.tooltip("show");
        } else if (control.data("error-style") === "inline") {
            if (group.find(".help-inline").length === 0) {
                group.find(".controls").append("<span class=\"help-inline error-message\"></span>");
            }
            target = group.find(".help-inline");
            return target.text(error);
        } else {
            if (group.find(".help-block").length === 0) {
                //Note don't change the string "Login failed" or it will show the unwanted error
                if (error === "Login failed"){
                    console.log("login failed");
                }else{
                    group.find(".controls").append("<p class=\"help-block error-message\"></p>");
                }
            }
            target = group.find(".help-block");
            return target.text(error);
        }
    }
});

$(function () {

    window.iru = {};

    //is this a instance or config page
    iru.instance = typeof TB_result === 'undefined' ? false : true;

    if (!iru.instance) {
        iru.configMainTemplate = Handlebars.compile($("#config").html());
        $("#main").html(iru.configMainTemplate());
    } else {
        iru.configMainTemplate = Handlebars.compile($("#instance").html());
        $("#main").html(iru.configMainTemplate());
    }

    //used to know if no configs exist when the config page is opened
    iru.fresh = true;

    iru.plugin_url = "/rundb/api/v1/plugin/" + TB_plugin.pk + "/";

    //grab the config object out of the plugin api, work with older IRU config objects
    if ('userconfigs' in TB_plugin.fields.config) {
        iru.AllUserConfigs = TB_plugin.fields.config;
        iru.initConfigs = TB_plugin.fields.config.userconfigs[TB_user];
    } else {
        TB_plugin.fields.config["userconfigs"] = {};
        iru.AllUserConfigs = TB_plugin.fields.config;
        iru.initConfigs = TB_plugin.fields.config.userconfigs[TB_user];
    }

    iru.Config = Backbone.Model.extend({
        initialize: function () {
            //set config id to a guid could this have been in the defaults instead?
            if (!this.has("id")) {
                this.set({"id": this.generateGuid()});
            }
        },
        generateGuid: function () {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        },
        authCheck: function(){
            var that = this;

            var extend_url = iru.plugin_url + "extend/auth/";
	    var extend_versions_url = iru.plugin_url + "extend/versions/";
            var authXHR = $.ajax({
                dataType: "json",
                contentType: "application/json",
                url: extend_url,
                type: "POST",
                data: JSON.stringify(that.toJSON())
            });
	    var versionsXHR = $.ajax({    
                dataType: "json",
                contentType: "application/json",
                url: extend_versions_url,
                type: "POST",
		data: JSON.stringify(that.toJSON())
            });
            authXHR.done(function(data){
                //The extend.py result is ambiguous at best. The endpoint returns status: 'true' but a stdout: "FAILED"
                // for failed auth checks. Work around here.
		var validVersions = [];
		dataPosted = that.toJSON();
		var version = dataPosted.version;
		var versionCheckPassed;
		versionsXHR.done(function(versionsList){
		    if(typeof versionsList["Version List"] !== 'undefined'){
		    	validVersions = versionsList["Version List"];
		    }
		    if(validVersions.length > 0 && validVersions.includes(version)){ //&& $.inArray(version, validVersions) == -1){
                    	versionCheckPassed = true;
                    }else{
			versionCheckPassed = false;
		    }
                    var authCheckPassed = (data["status"] === "true" && data["stdout"] != "FAILED");
		    console.log("Account name: " + dataPosted.name + ", authCheckPassed: " + authCheckPassed + ", versionCheckPassed: " + versionCheckPassed);
                    if (authCheckPassed && versionCheckPassed!='undefined' && versionCheckPassed===true){
                    	$("#" + that.get("id")).attr("src","/pluginMedia/IonReporterUploader/img/green.png");
                    	$("#" + that.get("id")).attr("title","Account is active and working");
                    	$('.status-icon').tooltip('destroy');
                    	$(".status-icon").tooltip({"placement": "left"});
                    }else{
                        $("#" + that.get("id")).attr("src","/pluginMedia/IonReporterUploader/img/red.png");
                        $("#" + that.get("id")).attr("title","Account is not working");
                        $('.status-icon').tooltip('destroy');
                        $(".status-icon").tooltip({"placement": "left"});
                    }
		});
            });

            authXHR.fail(function(data){
                $("#" + that.get("id")).attr("src","/pluginMedia/IonReporterUploader/img/red.png");
                $("#" + that.get("id")).attr("title","Account is not working, error with the IRU plugin");
                $('.status-icon').tooltip('destroy');
                $(".status-icon").tooltip({"placement": "left"});
            });

            return false;
        },
        validation: {
            name: {
                required: true,
                fn: function (value, attr, computedState) {
                    if (!iru.configs.uniqName(this, value))
                        return "Name is already being used";
                var asciiRegex = /^[\x00-\x7F]*$/;
        		if (!asciiRegex.test(value)) //Ensure all characters are ASCII
                        return "Name must not contain any special characters";
                }
            },
            port: {
                required: true,
                min: 1,
                max: 65535
            },
            server: {
                required: true
            },
            token: {
                fn: function (value, attr, computedState) {
                    //more legacy ir 1
                    //this might be needed for the ir 4 version check too
                }
            },
            userid: {
                fn: function (value, attr, computedState) {
                    if (!computedState["userid"]) {
                        return "Username is required"
                    }
                    if (value && !computedState["token"]) {
                        return "Login failed"
                    }
                }
            },
            password: {
                fn: function (value, attr, computedState) {
                    if (computedState["_details_timeout"]) {
                        console.log("timeout validation");
                        return ""
                    }
                    if (!value && !computedState["token"]) {
                        console.log(value);
                        console.log(attr);
                        console.log(computedState);
                        return "Password is required"
                    }
                    if (value && !computedState["token"]) {
                        return "Login failed"
                    }
                    if (computedState["_details_failed"]) {
                        console.log("_detailed_failed");
                        return "Unable to login"
                    }
                }
            },
            version: {
                fn: function (value, attr, computedState) {

                    if (computedState["_version_cache"]) {
                        if(value == "IR00") {
                            return "Select the version"
                        }
                    }
                    //TODO: add again for ir 4 version selection
                    //just keeping for legacy reasons
                }
            }
        }
    });

    iru.ConfigCollection = Backbone.Collection.extend({
        model: iru.Config,
        initialize: function () {
            this.on("change add", this.patch, this);
            this.on("remove", this.hideModel, this);
            this.on("reset", this.lengthCheck, this);
            this.patched = true;
            this.patchStatus = null;
        },
        lengthCheck: function () {
            if (this.length == 0) {
                $("#table-wrap").hide();
                //fade in the text after deleting the last item in a collection that once had things.
                if (iru.fresh) {
                    $("#whine").show();
                    $(".form-horizontal").hide();
                } else {
                    $("#whine").fadeIn(1500);
                }
            } else {
                $("#whine").hide();
                $("#table-wrap").show();
            }

            iru.fresh = false;
        },
        hideModel: function (model) {
            model.trigger("hide");
            this.patch();
        },
        setDefault: function (model) {
            this.each(function (config) {
                config.set({"default": false}, {silent: true});
            });
            model.set({"default": true});
        },
        anyDefault: function () {
            //are there any defaults set?
            var hasDefault = false;
            this.each(function (config) {
                if (config.get("default")) {
                    hasDefault = true;
                }
            });
            return hasDefault;
        },
        uniqName: function (model, name) {
            var uniq = true;
            this.each(function (config) {
                if (model.id != config.id) {
                    if (config.get("name") == name) {
                        uniq = false;
                    }
                }
            });
            return uniq;
        },
        patch: function () {
            this.lengthCheck();

            //Build the sub JSON that we want to use to PATCH with
            var data = {};
            data["config"] = iru.AllUserConfigs;
            data["config"]["userconfigs"][TB_user] = this.toJSON();

            var patchXHR = $.ajax({
                dataType: "json",
                contentType: "application/json",
                url: iru.plugin_url,
                type: "PATCH",
                async: false,
                data: JSON.stringify(data)
            });

            //tastypie returns a 202 on successful patch
            if (patchXHR.status !== 202) {
                this.patched = false;
                this.patchStatus = patchXHR.status;
                console.log("error");
            } else {
                this.patched = true;
            }
        },
        getPatchedInfo: function () {
           return {patched: this.patched, patchStatus: this.patchStatus};
        }
    });

    //Init the collection with the initConfigs
    iru.configs = new iru.ConfigCollection();
    iru.configs.reset(iru.initConfigs);

    iru.ConfigRowView = Backbone.View.extend({
        initialize: function () {
            this.model.on("hide", this.remove, this);
        },
        tagName: "tr",
        className: "zebra",
        events: {
            "click .config": "configModal"
        },
        configModal: function () {
            var configModalView = new iru.ConfigModalView({model: this.model});
            configModalView.render();
        },
        template: Handlebars.compile($("#row-layout").html()),
        render: function () {
            this.model.authCheck();
            this.$el.append(this.template(this.model.toJSON()));
            $("#table-body").append(this.el);
        }
    });

    iru.SelectRowView = Backbone.View.extend({
        initialize: function () {
        },
        tagName: "tr",
        className: "zebra",
        events: {
            "click .launch": "launch"
        },
        launch: function () {

            //TODO the aprise part of this

            //TODO do an auth check to make sure IR is alive
            var launchObj = this.model.toJSON();
            launchObj["launchoption"] = "upload_only";
            launchObj["iru_qc_option"] = "no_check";
            launchObj["upload"] = $("input[name='upload']:checked").val();

            //check to see if previous instance of plugin exists and still running
            var alreadyGoing = false;
            var pluginresult;
            $.ajax({
                type: 'GET',
                url: "/rundb/api/v1/results/" + TB_result + "/pluginresults/",
                contentType: "application/json; charset=utf-8",
                async: false,
                dataType: "json"
            }).done(function(data){
                pluginresult = $.map(data,function(pr) {
                    if(pr.Name === "IonReporterUploader"){return pr;}
                });
            });

            if(pluginresult.length>0){
                var extend_url = iru.plugin_url + "extend/lastrun/";
                var authXHR = $.ajax({
                    dataType: "json",
                    contentType: "application/json",
                    url: extend_url,
                    type: "POST",
                    async: false,
                    data: JSON.stringify({'pluginresult':pluginresult[0], 'version':TB_plugin.fields.version})
                }).done(function(data){
                    console.log('lastrun', data);
                    alreadyGoing = data.in_progress;
                });
            }

            if (alreadyGoing) {
                uploadMsg = "WARNING Are you sure you want to upload this, there is already an upload in progress?";
            } else {
                uploadMsg = "Are you sure you want to upload this?";
            }

            apprise(uploadMsg, {'verify': true}, function (r) {
                if (r) {
                    pluginAPIJSON = { "plugin": [TB_plugin.fields.name], "pluginconfig": launchObj };
                    pluginAPIJSON = JSON.stringify(pluginAPIJSON);
                    pluginURL = "/rundb/api/v1/results/" + TB_result + "/plugin/";
                    $.ajax({
                        type: 'POST',
                        url: pluginURL,
                        contentType: "application/json; charset=utf-8",
                        success: function (data) {
                            apprise("Upload Job is submitted. It will take a while to upload the files. It will take longer if it is a proton run. When the uploads are finished, you will receive an email on your email id registered with the Ion Reporter. Please do not re-submit till it is done.", {'verify': false}, function (r) {
                                parent.$.fn.colorbox.close();
                            });
                        },
                        data: pluginAPIJSON,
                        dataType: "json"
                    });
                }
            });
        },
        template: Handlebars.compile($("#select-row-layout").html()),
        render: function () {
            this.model.authCheck();
            this.$el.append(this.template(this.model.toJSON()));
            $("#table-body").append(this.el);
        }
    });

    iru.ConfigModalView = Backbone.View.extend({
        events: {
            "click .ir-back": "back",
            "click .add": "add",
            "click .update": "update",
            "click .ir-delete": "confirm",
            "click .confirmTrue": "deleteConfig",
            "click .confirmFalse": "confirmFalse",
            "keypress": "enterKey",
            "click .versionCheck": "versionCheck",
            "click .details": "details"
        },
        enterKey: function (e) {
            if (e.keyCode === 13) {
                if (this.isNew) {
                    this.add();
                } else {
                    this.update();
                }
            }
        },
        confirm: function () {
            $(".ir-delete").hide();
            $(".confirm").show();
        },
        confirmFalse: function () {
            $(".ir-delete").show();
            $(".confirm").hide();
        },
        deleteConfig: function () {
            $(".confirmTrue").button('loading');
            iru.configs.remove(this.model);
            this.back();
            $(".confirmTrue").button('reset');
        },
        update: function () {
            $(".update").button('loading');

            //Get version list first
            if (!this.model.has("_version_cache")) {
                this.versionCheck();
                $(".update").button('reset');
                $(".update").html("<i class='icon-ok'></i> Update");
                return
            }

            var orig = this.model.toJSON();
            var data = Backbone.Syphon.serialize(this);
            delete orig["password"];
            delete data["password"];
            var extended = _.extend(orig, data);


            //clone the the prior model data so we can try to do validation with the new info and revert if it fails
            var cloned = this.model.clone();

            //use silent to check validation
            this.model.set(extended);

            if ($("#password").val()) {
                this.details(true);
                console.log("password changed");
                this.model.validate();

                if (this.model.has("_details_failed")) {
                    console.log("there is a _details  login failed");
                    $(".update").button('reset');
                } else {
                    delete extended["token"];
                }
            }

            this.model.validate();

            if (!this.model.isValid()) {
                //the validation failed to replace the data with the cloned one from earlier.
                console.log("failed validation");

                //details alters the model, so we will have to as well.
                $(".update").button('reset');
                $(".update").button
                this.model.set(cloned.toJSON());
                return
            }

            this.model.set(extended);
            //set the default
            if (extended["default"] === true) {
                iru.configs.setDefault(this.model);
                iru.configListView.render();
            }
            this.back();
            $(".update").button('reset');
        },
        add: function () {

            $(".add").button('loading');

            var data = Backbone.Syphon.serialize(this);
            this.model.set(data);

            this.details(false);
            if (!this.model.has("token")) {
                $(".add").button('reset');
                console.log("there isn't a token");
            }
            if (this.model.has("_details_timeout")) {
                console.log("timeout innner");
                this.model.validate();
                $(".add").button('reset');
                return
            }

            this.model.validate();

            if (!this.model.isValid()) {
                console.log("not valid");
                $(".add").button('reset');
                if (this.model.has("_version_cache")) {
                    $(".add").html("<i class='icon-ok'></i> Add");
                }
                return
            }

            //Get version list first
            if (!this.model.has("_version_cache")) {
                this.versionCheck();
                $(".add").button('reset');
                $(".add").html("<i class='icon-ok'></i> Add");
                return
            }

            //set the default
            if (data["default"] === true) {
                iru.configs.setDefault(this.model);
                iru.configListView.render();
            }

            this.model.unset("password");
            iru.configs.add(this.model);
            var patchInfo = iru.configs.getPatchedInfo();
            if(patchInfo.patched){
                this.back();
                $(".add").button('reset');
            } else {
                iru.configs.remove(this.model);
                $(".add").button('reset');
                $(".add").html("<i class='icon-ok'></i> Add");
                if(patchInfo.patchStatus === 401) {
                    $("#timeout").html("You have insufficient privileges to add an IR account. Please contact your system administrator for assistance.");
                } else {
                    $("#timeout").html("Unexpected error has occurred. Please contact your system administrator for assistance.");
                }

                $("#timeout").show();
                return
            }
        },
        back: function () {
            $("#modal").html("");
            $("#list").show();
            this.model.unset("_details_failed");
            iru.configs.lengthCheck();
        },
        template: Handlebars.compile($("#modal_layout").html()),
        versionTemplate: Handlebars.compile($("#version").html()),
        versionStatusTemplate: Handlebars.compile($("#versionStatus").html()),
        versionCheck: function () {
            // Check if name and age are valid
            $(".version-group").html("");

            //hold onto this view
            var that = this;

            var orig = that.model.toJSON();
            var data = Backbone.Syphon.serialize(that);
            var extended = _.extend(orig, data);

            var extend_url = iru.plugin_url + "extend/versions/";

            $(".version-group").html("<img src='/site_media/jquery/img/throbber.gif'/>")

            var authXHR = $.ajax({
                dataType: "json",
                contentType: "application/json",
                url: extend_url,
                type: "POST",
                async: false,
                data: JSON.stringify(extended)
            });

            authXHR.done(function (data) {
                that.model.set({"_version_cache": data["Version List"].sort(function(a,b) {
                    if(parseInt(a[2]) < parseInt(b[2])) {
                        return -1;
                    } else if (parseInt(a[2]) > parseInt(b[2])) {
                        return 1;
                    } else {
                        return parseInt(a.substring(2)) - parseInt(b.substring(2));
                    }}) });

                $(".version-group").html("");
                that.versionRender(true);
            });

            authXHR.fail(function (data) {
                var msg = "Failed to get the version list. Please make sure all the values above are correct";
                $(".version-group").html(that.versionStatusTemplate({"error": true, "msg": msg, "status": "versionError"}));
            });

        },
        details: function (update) {
            var that = this;
            var orig = that.model.toJSON();
            var data = Backbone.Syphon.serialize(that);
            var extended = _.extend(orig, data);
            delete extended["default"];

            //hold onto this view
            var extend_url = iru.plugin_url + "extend/details/";
            var versions_url = iru.plugin_url + "extend/versions/";

            var authXHR = $.ajax({
                dataType: "json",
                contentType: "application/json",
                url: extend_url,
                type: "POST",
                async: false,
                data: JSON.stringify(extended)
            });

            authXHR.done(function (data) {
            	
                if (data["error"] === "none") {
                    $("#timeout").hide();
                    that.model.set({"details": data["details"], "token": data["details"]["token"]});
                    that.model.unset("_details_failed");
                    that.model.unset("_details_timeout");
                } else if (data["error"] === "Connection" && data["protocol_error"] === false) {
                    $("#timeout").show();
                    $("#timeout").html("Unable to connect to server, please check the server address and port");
                    that.model.unset("_details_failed");
                    that.model.set({"_details_timeout": true});
                } else if (data["protocol_error"] === true && data["error"] === "Connection") {
                    $("#timeout").show();
                    $("#timeout").html("Incorrect server type");
                    console.log("bad type");
                    that.model.unset("_details_failed");
                    that.model.set({"_details_timeout": true});
                } else if (data["error"] === "Timeout") {
                    $("#timeout").show();
                    $("#timeout").html("Unable to connect to server, please check the server address and port");
                    console.log("timed out");
                    that.model.unset("_details_failed");
                    that.model.set({"_details_timeout": true});
                } else if (data["error"] === "EULA_NOT_ACCEPPTED_EXCEPTION") {
                    $("#timeout").html("Unable to login, user is required to accept the End User License Agreement on Ion Reporter");
                    $("#timeout").show();
                    console.log("EULA not accepted");
                    that.model.set({"_details_failed": true});
                    that.model.unset("_details_timeout");
                    $("#password + p").html("");
                    $("#userid + p").html("");
                } else if (data["error"] !== "") {
                    $("#timeout").html("Unable to login, " + data["error"]);
                    $("#timeout").show();
                    console.log("generic extend api error");
                    that.model.set({"_details_failed": true});
                    that.model.unset("_details_timeout");
                    $("#password + p").html("");
                    $("#userid + p").html("");
                } else {
                    //$("#timeout").hide();
                    //console.log(that);
                    $("#timeout").html("Unable to login, either username or password is incorrect ");
                    $("#timeout").show();
                    that.model.unset("token");
                    console.log("Failed to check token");
                    that.model.set({"_details_failed": true});
                    that.model.unset("_details_timeout");
                    $("#password + p").html("");
                    $("#userid + p").html("");
                }
            });

            authXHR.fail(function (data) {
                if (!update) {
                    console.log("failed to access the extend details api");
                    console.log(data);
                } else {
                    console.log("failed to access the update extend details api");
                    //that.model.unset("_details");
                    that.model.set({"_details_failed": true});
                }
            });

        },
        legacy: function () {
            //legacy code, remove later
            return false
        },
        versionRender: function (isNew) {
            if (this.model.has("_version_cache")) {
                for (var i = 0, len = this.model.get("_version_cache").length; i < len; i++) {

                    var check = {"version": this.model.get("_version_cache")[i], "isNew": isNew};

                    if (this.model.get("version") === this.model.get("_version_cache")[i]) {
                        check["checked"] = "checked"
                    }

                    //Only show results other than the selected one if we are create a new account.
                    if(isNew || check["checked"] == "checked") {
                        $(".version-group").append(this.versionTemplate(check));
                    }
                }
            } else {
                var msg = "An account must specify the Ion Reporter version. </br> Once the server, port, and token have been entered above please click the button below to retrieve the list of available versions ";
                $(".version-group").html(this.versionStatusTemplate({"error": false, "msg": msg, "status": "versionStatus", "isNew": isNew}));
            }
        },
        render: function (isNew) {

            var renderTemp = this.model.toJSON();
            renderTemp["legacy"] = this.legacy();
            
            if (isNew) {
                renderTemp["isNew"] = true;
                renderTemp["storeText"] = "Get Versions";
                renderTemp["storeClass"] = "add";
                renderTemp["icon"] = "repeat";
                renderTemp["confirm"] = false;
                this.isNew = true;

                if (!iru.configs.anyDefault()) {
                    renderTemp["default"] = true;
                }

            } else {
                renderTemp["isNew"] = false;
                if (this.model.has("_version_cache")) {
                    renderTemp["storeText"] = "Update";
                    renderTemp["storeClass"] = "update";
                    renderTemp["icon"] = "ok";
                }else{
                    renderTemp["storeText"] = "Get Versions";
                    renderTemp["storeClass"] = "update";
                    renderTemp["icon"] = "repeat";
                }
                renderTemp["confirm"] = true;
                this.isNew = false;
            }
            //set the default radio button state
            if (this.model.get("protocol") === "http") {
                renderTemp["http"] = "checked";
                renderTemp["https"] = "";
            } else {
                renderTemp["http"] = "";
                renderTemp["https"] = "checked";
            }

            $("#list").hide();
            $("#whine").hide();
            this.$el.html(this.template(renderTemp));
            $("#modal").html(this.el);
            this.versionRender(isNew);
            window.location.href = "#ir-config";
            Backbone.Validation.bind(this);

        }

    });

    //collection view
    iru.ConfigListView = Backbone.View.extend({
        el: $("#table-body"),
        initialize: function () {
            this.collection.on("add", this.addOne, this);
            this.collection.on("reset", this.addAll, this);
            this.collection.on("change", this.render, this);
        },
        render: function () {
            $("#table-body").html("");
            this.addAll();
            $(".status-icon").tooltip({"placement": "left"});
        },
        addOne: function (config) {
            if (!iru.instance) {
                var configRowView = new iru.ConfigRowView({model: config});
                this.$el.append(configRowView.render());
            } else {
                var SelectRowView = new iru.SelectRowView({model: config});
                this.$el.append(SelectRowView.render());
            }
        },
        addAll: function () {
            this.collection.forEach(this.addOne, this);
        }
    });


    if (!iru.instance) {
        iru.configListView = new iru.ConfigListView({collection: iru.configs});
        iru.configListView.render();

        $("#ir4").click(function (e) {
            e.preventDefault();
            var scratchModel = new iru.Config();
            scratchModel.set({"version": "IR00", "port" : "443", "account_type": "ir"});
            var scratchModalView = new iru.ConfigModalView({model: scratchModel});
            //passing in true lets the view know this is a new model
            scratchModalView.render(true);
        });

         $("#ir7").click(function (e) {
            e.preventDefault();
            var scratchModel = new iru.Config();
            scratchModel.set({"version": "IR00", "port" : "443", "account_type": "ir7"});
            var scratchModalView = new iru.ConfigModalView({model: scratchModel});
            //passing in true lets the view know this is a new model
            scratchModalView.render(true);
        });

         $("#ir4Genexus").click(function (e) {
            e.preventDefault();
            var scratchModel = new iru.Config();
            scratchModel.set({"version": "IR00", "port" : "443" , "account_type": "Genexus"});
            var scratchModalView = new iru.ConfigModalView({model: scratchModel});
            //passing in true lets the view know this is a new model
            scratchModalView.render(true);
        });

        $("#ir40cloud").click(function (e) {
            e.preventDefault();
            var scratchModel = new iru.Config();
            scratchModel.set({"version": "IR00", "port" : "443" , "server": "40.dataloader.ionreporter.thermofisher.com", "account_type": "ir"});
            var scratchModalView = new iru.ConfigModalView({model: scratchModel});
            //passing in true lets the view know this is a new model
            scratchModalView.render(true);
        });

        $("#ir4china").click(function (e) {
            e.preventDefault();
            var scratchModel = new iru.Config();
            scratchModel.set({"version": "IR00", "port" : "443" , "server": "dataloader.china.ionreporter.thermofisher.com", "account_type": "ir"});
            var scratchModalView = new iru.ConfigModalView({model: scratchModel});
            //passing in true lets the view know this is a new model
            scratchModalView.render(true);
        });

    } else {
        if (TB_result_json["fields"]["status"] !== "Completed") {
            //TODO make a better error message
            var errorMessage = "Error(s) were found in the Torrent Suite Analysis Report, which may have affected the data to be uploaded to the Ion Reporter. One or more of the Samples associated with this report may not be uploaded / defined in the Ion Reporter if known errors were detected on the required files.";
            alert(errorMessage);
        }

        iru.configListView = new iru.ConfigListView({collection: iru.configs});
        iru.configListView.render();
    }


});
</script>

</head>

<body>

<div id="main" class="container"></div>

</body>
</html>
